<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>RTSP æ¨æµæ§åˆ¶å°</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* å¢å¼ºè¡¨å•å¯è¯»æ€§ */
        .param-box label {
            display: inline-block;
            width: 80px;
            margin: 10px 0;
        }
        .param-box select, .param-box input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .param-box select {
            width: 120px;
        }
        .delay-box code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
        }
        /* å°å±å¹•é€‚é… */
        @media (max-width: 600px) {
            .container { padding: 10px; }
            h1 { font-size: 1.5em; }
            .param-box select, .param-box input { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ RTSP æ¨æµç®¡ç†</h1>

        <div class="status-box">
            <h2>ğŸ“Š å½“å‰çŠ¶æ€</h2>
            <p><strong>æ¨æµçŠ¶æ€:</strong> <span id="status">æœªçŸ¥</span></p>
            <p><strong>RTSP åœ°å€:</strong> <code id="rtspUrl">åŠ è½½ä¸­...</code></p>
            <p><strong>æ’­æ”¾åœ°å€:</strong> <code>rtsp://ä½ çš„IP:8554/mystream</code></p>
        </div>

        <div class="control-box">
            <button id="startBtn" onclick="control('start')" disabled>â–¶ï¸ å¼€å§‹æ¨æµ</button>
            <button id="stopBtn" onclick="control('stop')" disabled>â¹ï¸ åœæ­¢æ¨æµ</button>
        </div>

        <!-- å‚æ•°è®¾ç½® -->
        <div class="param-box">
            <h2>âš™ï¸ å‚æ•°è®¾ç½®</h2>

            <label>åˆ†è¾¨ç‡:</label>
            <select id="resolution">
                <option value="320x240">320x240</option>
                <option value="640x480">640x480</option>
                <option value="800x600">800x600</option>
                <option value="1024x768">1024x768</option>
                <option value="1280x720">1280x720</option>
                <option value="1920x1080">1920x1080</option>
            </select><br>

            <label>å¸§ç‡:</label>
            <select id="fps">
                <option value="15">15</option>
                <option value="25">25</option>
                <option value="30">30</option>
                <option value="50">50</option>
                <option value="60">60</option>
            </select><br>

            <label>CRF:</label>
            <input type="number" id="crf" value="28" min="0" max="51" step="1"><br>

            <label>é¢„è®¾:</label>
            <select id="preset">
                <option value="ultrafast">ultrafast</option>
                <option value="superfast">superfast</option>
                <option value="veryfast">veryfast</option>
                <option value="faster">faster</option>
                <option value="fast">fast</option>
                <option value="medium">medium</option>
            </select><br>

            <button onclick="setParams()">ğŸ”„ åº”ç”¨å‚æ•°</button>
        </div>

        <!-- å»¶è¿Ÿä¿¡æ¯ -->
        <div class="delay-box">
            <h2>â±ï¸ å»¶è¿Ÿåˆ†æ</h2>
            <p><strong>é‡‡é›†å»¶è¿Ÿ:</strong> <span id="captureDelay">--</span> ms</p>
            <p><strong>ç¼–ç å»¶è¿Ÿ:</strong> <span id="encodeDelay">--</span> ms</p>
            <p><strong>è¾“å‡ºå»¶è¿Ÿ:</strong> <span id="outputDelay">--</span> ms</p>
            <p><strong>æ€»å»¶è¿Ÿ:</strong> <span id="totalDelay">--</span> ms</p>
            <p><small><em>æ³¨ï¼šå½“å‰ä¸ºâ€œå¯åŠ¨åˆ°é¦–å¸§è¾“å‡ºâ€æ€»å»¶è¿Ÿï¼Œå„é˜¶æ®µæš‚æœªç»†åˆ†</em></small></p>
        </div>

        <div class="log-box">
            <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
            <ul id="logList"></ul>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');

        function updateStatus() {
            fetch('/api/status')
                .then(res => res.json())
                .then(data => {
                    // çŠ¶æ€å’ŒæŒ‰é’®
                    document.getElementById('status').textContent = data.running ? 'ğŸŸ¢ è¿è¡Œä¸­' : 'ğŸ”´ å·²åœæ­¢';
                    document.getElementById('rtspUrl').textContent = data.rtsp_url;
                    startBtn.disabled = data.running;
                    stopBtn.disabled = !data.running;

                    // æ—¥å¿—
                    const logList = document.getElementById('logList');
                    logList.innerHTML = '';
                    data.log.forEach(line => {
                        const li = document.createElement('li');
                        li.textContent = line;
                        logList.appendChild(li);
                    });
                    logList.scrollTop = logList.scrollHeight;

                    // âœ… å‚æ•°å›æ˜¾ï¼ˆé€‰æ‹©é¡¹è‡ªåŠ¨é€‰ä¸­ï¼‰
                    if (data.resolution) {
                        const resSelect = document.getElementById('resolution');
                        for (let i = 0; i < resSelect.options.length; i++) {
                            if (resSelect.options[i].value === data.resolution) {
                                resSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    if (data.fps) document.getElementById('fps').value = data.fps;
                    if (data.crf) document.getElementById('crf').value = data.crf;
                    if (data.preset) document.getElementById('preset').value = data.preset;

                    // âœ… å»¶è¿Ÿä¿¡æ¯ï¼šåªæ˜¾ç¤ºæ€»å»¶è¿Ÿ
                    const delay = data.delay_info;
                    if (delay && delay.total > 0) {
                        const total = delay.total.toFixed(1);
                        document.getElementById('captureDelay').textContent = total;
                        document.getElementById('encodeDelay').textContent = total;
                        document.getElementById('outputDelay').textContent = total;
                        document.getElementById('totalDelay').textContent = total;
                    } else {
                        document.getElementById('captureDelay').textContent = '--';
                        document.getElementById('encodeDelay').textContent = '--';
                        document.getElementById('outputDelay').textContent = '--';
                        document.getElementById('totalDelay').textContent = '--';
                    }
                })
                .catch(err => {
                    console.error('çŠ¶æ€æ›´æ–°å¤±è´¥:', err);
                    document.getElementById('status').textContent = 'âŒ è¿æ¥å¤±è´¥';
                });
        }

        function control(action) {
            fetch('/api/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: action })
            })
            .then(res => res.json())
            .then(data => {
                console.log('æ§åˆ¶å“åº”:', data.result);
            })
            .catch(err => {
                console.error('æ§åˆ¶è¯·æ±‚å¤±è´¥:', err);
                alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ');
            });
        }

        function setParams() {
            const params = {
                resolution: document.getElementById('resolution').value,
                fps: parseInt(document.getElementById('fps').value),
                crf: parseInt(document.getElementById('crf').value),
                preset: document.getElementById('preset').value
            };
            fetch('/api/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'set_params', ...params })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.result);
            })
            .catch(err => {
                console.error('å‚æ•°è®¾ç½®å¤±è´¥:', err);
                alert('è®¾ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            });
        }

        // 1ç§’æ›´æ–°çŠ¶æ€
        setInterval(updateStatus, 1000);
        updateStatus(); // æ›´æ–°ä¸€æ¬¡
    </script>
</body>
</html>